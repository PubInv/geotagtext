<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Build your own geotag map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="styles.css" rel="stylesheet">
    <!---added Bootstrap-->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script>
    <!-- Firebase App is always required and must be first -->
    <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"></script>

    <!-- Add additional services that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-database.js"></script>
  </head>


  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
	  <li class="nav-item">
            <a class="nav-link" href="index.html">User Page</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="builder.html">App Builder<span class="sr-only">(current)</span></a>
          </li>
        </ul>
      </div>
    </nav>

    <h1 class="center">Map Application Builder</h1>

<!--    <form id="createapp"> -->
      <!--- action? -->
      <div class="mb-3">
	<label for="app-name" class="marginleft">Name of Application</label>
	<input type="text" id="app-name" class="marginleft">
      </div>
      <br>

      <div class="form-check marginleft">
	<input class="form-check-input" type="radio" name="name" id="yes-name" value="true">
	<label class="form-check-label" for="yes-name">
	  Ask for  name of geotagger
	</label>
      </div>
      <div class="form-check marginleft">
	<input class="form-check-input" type="radio" name="name" id="no-name" value="false" checked>
	<label class="form-check-label" for="no-name">
	  Don't ask for name
	</label>
      </div>
      <br>

      <div class="form-check marginleft">
	<input class="form-check-input" type="radio" name="text" id="yes-message" value="true">
	<label class="form-check-label" for="yes-message">
	  Ask for a text message
	</label>
      </div>
      <div class="form-check marginleft">
	<input class="form-check-input" type="radio" name="text" id="no-message" value="false" checked>
	<label class="form-check-label" for="no-message">
	  Don't ask for a message
	</label>
      </div>
      <br>

      <select class="form-select form-select-sm marginleft" aria-label=".form-select-sm example" id="icon">
	<option selected>choose marker icon</option>
	<option value="american-football-15.svg">Football</option>
	<option value="attraction-15.svg">Camera</option>
	<option value="car-15.svg">Car</option>
	<option value="marker-15.svg">Marker</option>
	<option value="gift-15.svg">Gift</option>
	<option value="hardware-15.svg">Tool</option>
	<option value="music-15.svg">Note</option>
      </select>
      <br><br><br>

      <p class="marginleft">Select any colors you want for your icon</p>
      <div class="form-check form-switch marginleft">
	<input class="form-check-input" type="checkbox" id="red" checked>
	<label class="form-check-label" for="red">Red</label>
      </div>
      <div class="form-check form-switch marginleft">
	<input class="form-check-input" type="checkbox" id="blue" checked>
	<label class="form-check-label" for="blue">Blue</label>
      </div>
      <div class="form-check form-switch marginleft">
	<input class="form-check-input" type="checkbox" id="green" checked>
	<label class="form-check-label" for="green">Green</label>
      </div>
      <br>

      <div class="form-check marginleft">
	<input class="form-check-input" type="checkbox" value="" id="yes-photo">
	<label class="form-check-label" for="yes-photo">
	  Ask for photo
	</label>
      </div>
      <br>

      <button onclick="createApplication()" class="btn btn-primary">Create Application</button>



</body>
<script type="text/javascript" src="firebase.js"></script>
<script>
  //Rob claims: you can make async because it returns Promise
  //return with Await (await checkForApp)
  //make it act like a boolean
  /*
  function checkForApp(appName) {
      return new Promise(function (resolve, reject) {
	  firebase.database().ref('/apps/' + appName).once('value')
	      .then(function(snapshot) {
		  if (snapshot.exists()) {
		      return resolve();
		  }
		  else {
		      return reject();
		  }
	      });
      });
  }*/


  const checkForApp = (appName) => {
      return new Promise((resolve) => {
	  firebase.database().ref('/apps/' + appName).once('value')
	      .then(function(snapshot) {
		  return resolve(snapshot.exists());
	      });
      });
  }
  

  function createApplication() {
  //const createApplication = async () => {
      //THIS COULD BE MADE SHORTER. SOLVING THE PROBLEM ITSELF IS A GOOD IDEA, BUT I DON'T UNDERSTAND HOW TO CHANGE IT.
      var name = $('input[name=name]:checked', '#createapp').val();
      if (name == "false") {
	  name = false;
      }
      else {
	  name = true;
      }
      var textmessage = $('input[name=text]:checked', '#createapp').val();
       if (textmessage == "false") {
	  textmessage = false;
      }
      else {
	  textmessage = true;
      }

      var icon = $("#icon").val();
      var red = $("#red").is(":checked");
      var blue = $("#blue").is(":checked");
      var green = $("#green").is(":checked");
      var photo = $("#yes-photo").is(":checked");
      var appName = $("#app-name").val();


      var stop;
      if (blue==false && green==false && red ==false) {
	  stop = true;
      } //maybe this can go directly into if statement on line193

      function actuallyCreate(appName) {
	  if (stop == true || icon == "choose marker icon" || appName == "") {
	      alert("Please fill out all fields");
	  }
	  else {
	      var config = { yesname: name,
			     yestextmessage: textmessage,
			     icon: icon,
			     red: red,
			     blue: blue,
			     green: green,
			     yesphoto: photo,
                             tags: {},
			   };

	      firebase.database().ref('apps/' + appName).set(config,
							     function(error) {
								 if (error) {
								     // The write failed...
								     console.log("ERROR:",error);
								 } else {
								     // Data saved successfully!
								     console.log("SUCCESS");
								 }
							     });
	  }
      }
/*
      checkForApp(appName)
	  .then(function() { console.log("XXX");
                             alert("This app name already exists. Please find another one.");
			   })
	  .catch(function() { console.log("YYY");
                       	      //alert("name text icon rbg photo" + name +" "+ textmessage +" "+ icon + red +" "+ blue +" "+ green + " " + photo);
	                      //alert("this application doesn't exist");
                              actuallyCreate(appName);});
*/
      const appThere = await checkForApp(appName);
      if (appThere) {
	  alert("This app name already exists. Please find another one.");
      }
      else {
	  actuallyCreate(appName);
      }

</script>


</html>
